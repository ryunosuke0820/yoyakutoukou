name: FANZA Auto Post (All Sites)

on:
  workflow_dispatch:
    inputs:
      site:
        description: '対象サイト (空欄で全サイト)'
        required: false
        default: ''
      limit:
        description: '1サイトあたりの投稿数'
        required: false
        default: '5'
  
  # スケジュール実行（UTC時間）
  schedule:
    - cron: '0 0 * * *'   # JST 9:00
    - cron: '30 3 * * *'  # JST 12:30
    - cron: '0 11 * * *'  # JST 20:00
    - cron: '0 14 * * *'  # JST 23:00

jobs:
  post:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    strategy:
      fail-fast: false
      max-parallel: 1
      matrix:
        site:
          - sd01-chichi
          - sd02-shirouto
          - sd03-gyaru
          - sd04-chijo
          - sd05-seiso
          - sd06-hitozuma
          - sd07-oneesan
          - sd08-jukujo
          - sd09-iyashi
          - sd10-otona
    
    steps:
      - name: Check if site should run
        id: check
        run: |
          INPUT_SITE="${{ github.event.inputs.site }}"
          MATRIX_SITE="${{ matrix.site }}"
          if [ -z "$INPUT_SITE" ] || [ "$INPUT_SITE" = "$MATRIX_SITE" ]; then
            echo "should_run=true" >> $GITHUB_OUTPUT
          else
            echo "should_run=false" >> $GITHUB_OUTPUT
          fi
      
      - name: Checkout repository
        if: steps.check.outputs.should_run == 'true'
        uses: actions/checkout@v4
      
      - name: Set up Python
        if: steps.check.outputs.should_run == 'true'
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: Install dependencies
        if: steps.check.outputs.should_run == 'true'
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: Set site-specific secrets
        if: steps.check.outputs.should_run == 'true'
        run: |
          # 共通設定
          echo "FANZA_API_KEY=${{ secrets.FANZA_API_KEY }}" >> .env
          echo "FANZA_AFFILIATE_ID=${{ secrets.FANZA_AFFILIATE_ID }}" >> .env
          echo "OPENAI_API_KEY=${{ secrets.OPENAI_API_KEY }}" >> .env
          echo "WP_USERNAME=${{ secrets.WP_USERNAME }}" >> .env
          
          # サイト別URL
          echo "WP_BASE_URL=https://${{ matrix.site }}.av-kantei.com" >> .env
          
          # サイト別Application Password
          case "${{ matrix.site }}" in
            sd01-chichi)   echo "WP_APP_PASSWORD=${{ secrets.WP_APP_PASSWORD }}" >> .env ;;
            sd02-shirouto) echo "WP_APP_PASSWORD=${{ secrets.WP_APP_PASSWORD_SD02 }}" >> .env ;;
            sd03-gyaru)    echo "WP_APP_PASSWORD=${{ secrets.WP_APP_PASSWORD_SD03 }}" >> .env ;;
            sd04-chijo)    echo "WP_APP_PASSWORD=${{ secrets.WP_APP_PASSWORD_SD04 }}" >> .env ;;
            sd05-seiso)    echo "WP_APP_PASSWORD=${{ secrets.WP_APP_PASSWORD_SD05 }}" >> .env ;;
            sd06-hitozuma) echo "WP_APP_PASSWORD=${{ secrets.WP_APP_PASSWORD_SD06 }}" >> .env ;;
            sd07-oneesan)  echo "WP_APP_PASSWORD=${{ secrets.WP_APP_PASSWORD_SD07 }}" >> .env ;;
            sd08-jukujo)   echo "WP_APP_PASSWORD=${{ secrets.WP_APP_PASSWORD_SD08 }}" >> .env ;;
            sd09-iyashi)   echo "WP_APP_PASSWORD=${{ secrets.WP_APP_PASSWORD_SD09 }}" >> .env ;;
            sd10-otona)    echo "WP_APP_PASSWORD=${{ secrets.WP_APP_PASSWORD_SD10 }}" >> .env ;;
          esac
      
      - name: Run FANZA Bot
        if: steps.check.outputs.should_run == 'true'
        run: |
          LIMIT="${{ github.event.inputs.limit }}"
          python scripts/run_batch.py --subdomain ${{ matrix.site }} --limit ${LIMIT:-5}
      
      - name: Commit posted database
        if: steps.check.outputs.should_run == 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git pull --rebase || true
          git add data/posted_${{ matrix.site }}.sqlite3 || true
          git diff --staged --quiet || git commit -m "chore: update posted_${{ matrix.site }}.sqlite3"
          git push || true
