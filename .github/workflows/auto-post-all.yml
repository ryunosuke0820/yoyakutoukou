name: FANZA Auto Post (All Sites)

on:
  workflow_dispatch:
    inputs:
      site:
        description: 'Target site (blank = all sites)'
        required: false
        default: ''
      limit:
        description: 'Number of posts per site'
        required: false
        default: '5'

  schedule:
    - cron: '30 22 * * *'  # JST 07:30
    - cron: '10 3 * * *'   # JST 12:10
    - cron: '0 13 * * *'   # JST 22:00
    - cron: '10 14 * * *'  # JST 23:10

jobs:
  post:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    strategy:
      fail-fast: false
      max-parallel: 1
      matrix:
        site:
          - sd01-chichi
          - sd02-shirouto
          - sd03-gyaru
          - sd04-chijo
          - sd05-seiso
          - sd06-hitozuma
          - sd07-oneesan
          - sd08-jukujo
          - sd09-iyashi
          - sd10-otona

    steps:
      - name: Check if site should run
        id: check
        run: |
          INPUT_SITE="${{ github.event.inputs.site }}"
          MATRIX_SITE="${{ matrix.site }}"
          if [ -z "$INPUT_SITE" ] || [ "$INPUT_SITE" = "$MATRIX_SITE" ]; then
            echo "should_run=true" >> $GITHUB_OUTPUT
          else
            echo "should_run=false" >> $GITHUB_OUTPUT
          fi

      - name: Checkout repository
        if: steps.check.outputs.should_run == 'true'
        uses: actions/checkout@v4

      - name: Set up Python
        if: steps.check.outputs.should_run == 'true'
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        if: steps.check.outputs.should_run == 'true'
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt

      - name: Set site-specific secrets
        if: steps.check.outputs.should_run == 'true'
        run: |
          set -euo pipefail

          FANZA_API_KEY="${{ secrets.FANZA_API_KEY }}"
          FANZA_AFFILIATE_ID="${{ secrets.FANZA_AFFILIATE_ID }}"
          OPENAI_API_KEY="${{ secrets.OPENAI_API_KEY }}"
          WP_USERNAME="${{ secrets.WP_USERNAME }}"

          case "${{ matrix.site }}" in
            sd01-chichi)   WP_APP_PASSWORD="${{ secrets.WP_APP_PASSWORD }}" ;;
            sd02-shirouto) WP_APP_PASSWORD="${{ secrets.WP_APP_PASSWORD_SD02 }}" ;;
            sd03-gyaru)    WP_APP_PASSWORD="${{ secrets.WP_APP_PASSWORD_SD03 }}" ;;
            sd04-chijo)    WP_APP_PASSWORD="${{ secrets.WP_APP_PASSWORD_SD04 }}" ;;
            sd05-seiso)    WP_APP_PASSWORD="${{ secrets.WP_APP_PASSWORD_SD05 }}" ;;
            sd06-hitozuma) WP_APP_PASSWORD="${{ secrets.WP_APP_PASSWORD_SD06 }}" ;;
            sd07-oneesan)  WP_APP_PASSWORD="${{ secrets.WP_APP_PASSWORD_SD07 }}" ;;
            sd08-jukujo)   WP_APP_PASSWORD="${{ secrets.WP_APP_PASSWORD_SD08 }}" ;;
            sd09-iyashi)   WP_APP_PASSWORD="${{ secrets.WP_APP_PASSWORD_SD09 }}" ;;
            sd10-otona)    WP_APP_PASSWORD="${{ secrets.WP_APP_PASSWORD_SD10 }}" ;;
            *)
              echo "Unknown site: ${{ matrix.site }}" >&2
              exit 1
              ;;
          esac

          if [ -z "$FANZA_API_KEY" ] || [ -z "$FANZA_AFFILIATE_ID" ] || [ -z "$OPENAI_API_KEY" ] || [ -z "$WP_USERNAME" ] || [ -z "$WP_APP_PASSWORD" ]; then
            echo "Missing required secrets for site=${{ matrix.site }}." >&2
            echo "Required: FANZA_API_KEY, FANZA_AFFILIATE_ID, OPENAI_API_KEY, WP_USERNAME, site-specific WP_APP_PASSWORD." >&2
            exit 1
          fi

          WP_PASS_RAW_LEN=${#WP_APP_PASSWORD}
          WP_APP_PASSWORD="$(printf '%s' "$WP_APP_PASSWORD" | tr -d '[:space:]')"
          WP_PASS_CLEAN_LEN=${#WP_APP_PASSWORD}

          {
            echo "FANZA_API_KEY=$FANZA_API_KEY"
            echo "FANZA_AFFILIATE_ID=$FANZA_AFFILIATE_ID"
            echo "OPENAI_API_KEY=$OPENAI_API_KEY"
            echo "WP_USERNAME=$WP_USERNAME"
            echo "WP_BASE_URL=https://${{ matrix.site }}.av-kantei.com"
            echo "WP_APP_PASSWORD=$WP_APP_PASSWORD"
          } >> .env

          echo "Using site=${{ matrix.site }}"
          echo "Username length: ${#WP_USERNAME}"
          echo "Password length(raw): ${WP_PASS_RAW_LEN}"
          echo "Password length(clean): ${WP_PASS_CLEAN_LEN}"

      - name: Verify WordPress auth/role
        if: steps.check.outputs.should_run == 'true'
        run: |
          python - << 'PY'
          import os
          import requests
          from dotenv import load_dotenv

          load_dotenv('.env')
          base = os.getenv('WP_BASE_URL', '').rstrip('/')
          user = os.getenv('WP_USERNAME', '')
          app = os.getenv('WP_APP_PASSWORD', '')
          auth = (user, app)

          me = requests.get(f"{base}/wp-json/wp/v2/users/me", auth=auth, timeout=20)
          if me.status_code != 200:
              print('WP auth failed:', me.status_code, me.text[:500])
              raise SystemExit(1)

          media = requests.post(
              f"{base}/wp-json/wp/v2/media",
              auth=auth,
              headers={'Content-Type': 'image/gif', 'Content-Disposition': 'attachment; filename=probe.gif'},
              data=b'GIF89a\x01\x00\x01\x00\x80\x00\x00\x00\x00\x00\xff\xff\xff!\xf9\x04\x01\x00\x00\x00\x00,\x00\x00\x00\x00\x01\x00\x01\x00\x00\x02\x02D\x01\x00;',
              timeout=20,
          )
          if media.status_code != 201:
              print('WP media permission failed:', media.status_code, media.text[:500])
              raise SystemExit(1)

          mid = media.json().get('id')
          if mid:
              requests.delete(f"{base}/wp-json/wp/v2/media/{mid}", params={'force': 'true'}, auth=auth, timeout=20)
          print('WP auth/role OK')
          PY

      - name: Run FANZA Bot
        if: steps.check.outputs.should_run == 'true'
        run: |
          LIMIT="${{ github.event.inputs.limit }}"
          USE_CDN_IMAGES=true REQUIRE_FEATURED_MEDIA=false python scripts/run_batch.py --subdomain ${{ matrix.site }} --limit ${LIMIT:-5}

      - name: Normalize SD posts (lightweight after posting)
        if: steps.check.outputs.should_run == 'true'
        run: |
          python scripts/normalize_sd_posts.py --site-id "${{ matrix.site }}" --base-url "https://${{ matrix.site }}.av-kantei.com" --status publish --max-pages 2 --per-page 20

      - name: Verify latest published posts
        if: steps.check.outputs.should_run == 'true'
        run: |
          python - << 'PY'
          import os
          import requests
          from dotenv import load_dotenv

          load_dotenv(".env")
          base = os.getenv("WP_BASE_URL", "").rstrip("/")
          url = f"{base}/wp-json/wp/v2/posts"
          resp = requests.get(
              url,
              params={"per_page": 3, "orderby": "date", "order": "desc", "_fields": "id,date,slug,link,title"},
              timeout=20,
          )
          resp.raise_for_status()
          posts = resp.json() or []
          print(f"Latest published posts on {base}: {len(posts)}")
          for p in posts:
              title = (p.get("title") or {}).get("rendered", "")
              print(f"- id={p.get('id')} date={p.get('date')} slug={p.get('slug')} link={p.get('link')} title={title[:80]}")
          PY

      - name: Commit posted database
        if: steps.check.outputs.should_run == 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git pull --rebase || true
          git add data/posted_${{ matrix.site }}.sqlite3 || true
          git diff --staged --quiet || git commit -m "chore: update posted_${{ matrix.site }}.sqlite3"
          git push || true
