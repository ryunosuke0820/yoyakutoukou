name: FANZA Auto Post

on:
  # 手動実行用
  workflow_dispatch:
  
  # スケジュール実行（UTC時間）
  # 1日20記事 = 5記事×4回
  schedule:
    - cron: '0 0 * * *'   # UTC 0:00 = JST 9:00
    - cron: '30 2 * * *'  # UTC 2:30 = JST 11:30
    - cron: '0 6 * * *'   # UTC 6:00 = JST 15:00
    - cron: '0 12 * * *'  # UTC 12:00 = JST 21:00

jobs:
  post:
    runs-on: ubuntu-latest
    permissions:
      contents: write  # これを追加：投稿済みIDを保存するためにリポジトリへの書き込みを許可
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: Create .env file
        run: |
          echo "FANZA_API_KEY='${{ secrets.FANZA_API_KEY }}'" >> .env
          echo "FANZA_AFFILIATE_ID='${{ secrets.FANZA_AFFILIATE_ID }}'" >> .env
          echo "OPENAI_API_KEY='${{ secrets.OPENAI_API_KEY }}'" >> .env
          echo "WP_BASE_URL='${{ secrets.WP_BASE_URL }}'" >> .env
          echo "WP_USERNAME='${{ secrets.SD_WP_USERNAME }}'" >> .env
          echo "WP_APP_PASSWORD='${{ secrets.SD_WP_APP_PASSWORD }}'" >> .env
      
      - name: Run FANZA Bot (sd01)
        run: python scripts/run_batch.py --subdomain sd01-chichi --limit 5
      
      - name: Commit posted database
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add data/posted_sd01-chichi.sqlite3 || true
          git diff --staged --quiet || git commit -m "chore: update posted_sd01-chichi.sqlite3"
          git push
