name: Schedule SD Drafts Publish

on:
  workflow_dispatch:
    inputs:
      sites:
        description: "Target sites (comma separated, e.g. sd01-chichi,sd02-shirouto or all)"
        required: false
        default: "all"
      dry_run:
        description: "Dry-run only (no WP update)"
        required: false
        default: "false"
      reset_progress:
        description: "Reset progress before run"
        required: false
        default: "false"
      start_jst:
        description: "Start slot in JST (optional, ISO8601)"
        required: false
        default: ""
      interval_minutes:
        description: "Interval minutes between slots"
        required: false
        default: "12"
      max_items:
        description: "How many draft posts to schedule in this run (0 = all)"
        required: false
        default: "100"

  schedule:
    # daily 00:00 JST (= 15:00 UTC previous day)
    - cron: "0 15 * * *"

concurrency:
  group: schedule-sd-drafts-publish
  cancel-in-progress: false

jobs:
  schedule:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"

      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt

      - name: Prepare .env for scheduler
        run: |
          set -euo pipefail

          {
            echo "WP_BASE_URL=https://av-kantei.com"
            echo "WP_USERNAME=${WP_USERNAME}"
            echo "WP_USERNAME_SD01=${WP_USERNAME_SD01}"
            echo "WP_USERNAME_SD02=${WP_USERNAME_SD02}"
            echo "WP_USERNAME_SD03=${WP_USERNAME_SD03}"
            echo "WP_USERNAME_SD04=${WP_USERNAME_SD04}"
            echo "WP_USERNAME_SD05=${WP_USERNAME_SD05}"
            echo "WP_USERNAME_SD06=${WP_USERNAME_SD06}"
            echo "WP_USERNAME_SD07=${WP_USERNAME_SD07}"
            echo "WP_USERNAME_SD08=${WP_USERNAME_SD08}"
            echo "WP_USERNAME_SD09=${WP_USERNAME_SD09}"
            echo "WP_USERNAME_SD10=${WP_USERNAME_SD10}"
            echo "WP_APP_PASSWORD=${WP_APP_PASSWORD}"
            echo "WP_APP_PASSWORD_SD01=${WP_APP_PASSWORD_SD01}"
            echo "WP_APP_PASSWORD_SD02=${WP_APP_PASSWORD_SD02}"
            echo "WP_APP_PASSWORD_SD03=${WP_APP_PASSWORD_SD03}"
            echo "WP_APP_PASSWORD_SD04=${WP_APP_PASSWORD_SD04}"
            echo "WP_APP_PASSWORD_SD05=${WP_APP_PASSWORD_SD05}"
            echo "WP_APP_PASSWORD_SD06=${WP_APP_PASSWORD_SD06}"
            echo "WP_APP_PASSWORD_SD07=${WP_APP_PASSWORD_SD07}"
            echo "WP_APP_PASSWORD_SD08=${WP_APP_PASSWORD_SD08}"
            echo "WP_APP_PASSWORD_SD09=${WP_APP_PASSWORD_SD09}"
            echo "WP_APP_PASSWORD_SD10=${WP_APP_PASSWORD_SD10}"
            echo "MIN_CHARS=1100"
            echo "MAX_CHARS=1300"
            echo "POST_STATUS=draft"
          } > .env

          echo "Secret presence check:"
          [ -n "${WP_USERNAME:-}" ] && echo "WP_USERNAME=SET" || echo "WP_USERNAME=EMPTY"
          [ -n "${WP_APP_PASSWORD:-}" ] && echo "WP_APP_PASSWORD=SET" || echo "WP_APP_PASSWORD=EMPTY"
          [ -n "${WP_USERNAME_SD04:-}" ] && echo "WP_USERNAME_SD04=SET" || echo "WP_USERNAME_SD04=EMPTY"
          [ -n "${WP_APP_PASSWORD_SD04:-}" ] && echo "WP_APP_PASSWORD_SD04=SET" || echo "WP_APP_PASSWORD_SD04=EMPTY"
        env:
          WP_USERNAME: ${{ secrets.WP_USERNAME }}
          WP_USERNAME_SD01: ${{ secrets.WP_USERNAME_SD01 }}
          WP_USERNAME_SD02: ${{ secrets.WP_USERNAME_SD02 }}
          WP_USERNAME_SD03: ${{ secrets.WP_USERNAME_SD03 }}
          WP_USERNAME_SD04: ${{ secrets.WP_USERNAME_SD04 }}
          WP_USERNAME_SD05: ${{ secrets.WP_USERNAME_SD05 }}
          WP_USERNAME_SD06: ${{ secrets.WP_USERNAME_SD06 }}
          WP_USERNAME_SD07: ${{ secrets.WP_USERNAME_SD07 }}
          WP_USERNAME_SD08: ${{ secrets.WP_USERNAME_SD08 }}
          WP_USERNAME_SD09: ${{ secrets.WP_USERNAME_SD09 }}
          WP_USERNAME_SD10: ${{ secrets.WP_USERNAME_SD10 }}
          WP_APP_PASSWORD: ${{ secrets.WP_APP_PASSWORD }}
          WP_APP_PASSWORD_SD01: ${{ secrets.WP_APP_PASSWORD_SD01 }}
          WP_APP_PASSWORD_SD02: ${{ secrets.WP_APP_PASSWORD_SD02 }}
          WP_APP_PASSWORD_SD03: ${{ secrets.WP_APP_PASSWORD_SD03 }}
          WP_APP_PASSWORD_SD04: ${{ secrets.WP_APP_PASSWORD_SD04 }}
          WP_APP_PASSWORD_SD05: ${{ secrets.WP_APP_PASSWORD_SD05 }}
          WP_APP_PASSWORD_SD06: ${{ secrets.WP_APP_PASSWORD_SD06 }}
          WP_APP_PASSWORD_SD07: ${{ secrets.WP_APP_PASSWORD_SD07 }}
          WP_APP_PASSWORD_SD08: ${{ secrets.WP_APP_PASSWORD_SD08 }}
          WP_APP_PASSWORD_SD09: ${{ secrets.WP_APP_PASSWORD_SD09 }}
          WP_APP_PASSWORD_SD10: ${{ secrets.WP_APP_PASSWORD_SD10 }}

      - name: Run scheduler
        run: |
          set -euo pipefail

          DRY_RUN="${{ github.event.inputs.dry_run }}"
          RESET_PROGRESS="${{ github.event.inputs.reset_progress }}"
          START_JST="${{ github.event.inputs.start_jst }}"
          INTERVAL_MINUTES="${{ github.event.inputs.interval_minutes }}"
          MAX_ITEMS="${{ github.event.inputs.max_items }}"
          SITES="${{ github.event.inputs.sites }}"

          # Defaults for scheduled runs (workflow_dispatch inputs are empty on cron)
          if [ -z "${MAX_ITEMS}" ]; then MAX_ITEMS="100"; fi
          if [ -z "${DRY_RUN}" ]; then DRY_RUN="false"; fi
          if [ -z "${RESET_PROGRESS}" ]; then RESET_PROGRESS="false"; fi
          if [ -z "${INTERVAL_MINUTES}" ]; then INTERVAL_MINUTES="12"; fi
          if [ -z "${SITES}" ]; then SITES="all"; fi

          CMD="python scripts/schedule_sd_drafts_publish.py --sites ${SITES} --max-items ${MAX_ITEMS} --interval-minutes ${INTERVAL_MINUTES} --output-dir data/schedule_publish_sd"
          if [ -n "${START_JST}" ]; then CMD="${CMD} --start-jst ${START_JST}"; fi
          if [ "${DRY_RUN}" = "true" ]; then CMD="${CMD} --dry-run"; fi
          if [ "${RESET_PROGRESS}" = "true" ]; then CMD="${CMD} --reset-progress"; fi

          echo "Running: ${CMD}"
          eval "${CMD}"

      - name: Upload scheduler outputs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: schedule-sd-drafts-publish
          path: data/schedule_publish_sd/
          if-no-files-found: ignore

      - name: Commit progress/manifest
        if: always()
        run: |
          set -euo pipefail
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git pull --rebase || true
          git add data/schedule_publish_sd/progress.json data/schedule_publish_sd/manifest.json .env || true
          git restore --staged .env || true
          git checkout -- .env || true
          git diff --staged --quiet || git commit -m "chore: update sd draft schedule progress"
          git push || true
